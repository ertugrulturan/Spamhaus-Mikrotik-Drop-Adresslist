name: Generate Spamhaus DROP List for MikroTik

on:
  schedule:
    - cron: '0 0 */2 * *'
  workflow_dispatch:

jobs:
  generate-drop-list:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install dependencies
      run: sudo apt-get install -y curl

    - name: Generate Spamhaus DROP list in MikroTik format
      run: |
        curl -s https://www.spamhaus.org/drop/drop.txt -o drop.txt

        output_file="spamhaus_drops.rsc"

        echo "# Generated by custom script on $(date)" > $output_file
        echo "/ip firewall address-list" >> $output_file

        grep -E "^[0-9]" drop.txt | while read -r line; do
          # Subnet bilgisini al
          subnet=$(echo "$line" | awk '{print $1}')
          
          echo "add list=SpamHaus address=$subnet" >> $output_file
        done

        cat $output_file

    - name: Commit and push the .rsc file
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        git add spamhaus_drops.rsc

        # By Ertugrul
        git commit -m "Update Spamhaus DROP list ($(date))"

        # Commit'i push et
        git push
